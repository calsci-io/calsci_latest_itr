# Copyright (c) 2025 CalSci
# Licensed under the MIT License.

import utime as time  # type:ignore
from urandom import getrandbits  # type:ignore
from data_modules.object_handler import (
    app,
    current_app,
    display,
    form,
    form_refresh,
    keypad_state_manager,
    nav,
    text,
    text_refresh,
    typer,
)

# LOREM_50_WORDS = (
#     "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor "
#     "incididunt ut labore et dolore magna aliqua. Vestibulum ante ipsum primis in "
#     "faucibus orci luctus et ultrices posuere cubilia curae; Integer non turpis ac "
#     "velit fermentum posuere. Cras vitae sem nec ipsum aliquet, justo at feugiat "
#     "velit interdum."
# )

LOREM_50_WORDS = (
    "Bandi 'patana' trick nahi, connection hota hai. Confident raho, clean dikho, "
    "apni life aur goals pe focus karo. Normal conversation se start karo, zyada "
    "suno, thoda humour rakho. Desperate mat lagna. 2-3 achhi baat ke baad seedha "
    "coffee ke liye pucho. Mana kare to respect karo."
)


NOISE_CHARS = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
TEXT_COLS = 21


def _line21(s):
    s = str(s)
    if len(s) > TEXT_COLS:
        return s[:TEXT_COLS]
    return s.center(TEXT_COLS)


def _render_text_lines(lines, state="ChatGPT"):
    text.all_clear()
    text.update_buffer("".join(_line21(line) for line in lines))
    text_refresh.new = True
    text_refresh.refresh(state=state)

chatgpt_logo_128x64 = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\xe0\xf0\xf8\xf8\x7c\x7c\x3e\x1e\x1f\x1f\x0f\x0f\x0f\x0f\x0f\x1f\x1f\x1e\x3e\xbc\xfc\xf8\xf8\xf0\xe0\xe0\xe0\xe0\xe0\xe0\xe0\xe0\xc0\xc0\xc0\x80\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\xc0\xe0\xe0\xf0\xf0\xf0\xf8\xfc\xff\xff\xff\x07\x03\x00\x00\x00\x80\xc0\xc0\xe0\xe0\xf0\xf8\xf8\x7c\x7c\x3e\x1e\x1f\x0f\x0f\x07\x07\x03\x03\x83\x01\x01\x01\x01\x01\x03\x03\x03\x07\x0f\x1f\x3f\x7e\xfc\xf8\xf0\xe0\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\xf0\xfc\xfe\xff\x3f\x0f\x07\x03\x01\x01\x00\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\xff\xff\xff\x03\x01\x81\x80\xc0\xe0\xe0\xf0\xf0\xf8\xf8\x9c\x1c\x0e\x0f\x07\x0f\x0f\x1f\x1e\x3e\x7c\x7c\xf8\xf8\xf0\xe0\xe0\xc0\xc0\x81\xff\xff\xff\xff\x78\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xff\xff\xff\xe1\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xc0\x00\x00\x00\x00\x00\xff\xff\xff\x0f\x07\x07\x03\x01\x01\x00\x00\x01\x01\x03\x07\x07\x0f\xfe\xfe\xfc\x38\x78\x70\xf0\xe0\xe0\xc0\x80\x81\x01\x03\x07\x07\x0f\x1f\x3f\xff\xff\xf8\xf0\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x0f\x1f\xff\xff\xfc\xf8\xf0\xe0\xe0\xc0\x80\x81\x01\x03\x07\x07\x0f\x0e\x1e\x1c\x3f\x7f\x7f\xf0\xe0\xe0\xc0\x80\x80\x00\x00\x80\x80\xc0\xe0\xe0\xf0\xff\xff\xff\x00\x00\x00\x00\x00\x03\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x87\xff\xff\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0e\xff\xff\xff\xff\x81\x03\x03\x07\x07\x0f\x1f\x1f\x3e\x3e\x7c\x78\xf8\xf0\xf0\xe0\xf0\x70\x78\x39\x1f\x1f\x0f\x0f\x07\x07\x03\x01\x81\x80\xc0\xff\xff\xff\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\x00\x80\x80\xc0\xe0\xf0\xfc\xff\x7f\x3f\x0f\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x07\x0f\x1f\x3f\x7e\xfc\xf8\xf0\xe0\xc0\xc0\xc0\xc0\x80\x80\x80\x80\xc1\xc0\xc0\xe0\xe0\xf0\xf0\xf8\x78\x7c\x3e\x3e\x1f\x1f\x0f\x07\x07\x03\x03\x01\x00\x00\x00\xc0\xe0\xff\xff\xff\x3f\x1f\x0f\x0f\x0f\x07\x07\x03\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x01\x03\x03\x03\x07\x07\x07\x07\x07\x07\x07\x07\x0f\x1f\x1f\x3f\x3d\x7c\x78\xf8\xf8\xf0\xf0\xf0\xf0\xf0\xf8\xf8\x78\x7c\x3e\x3e\x1f\x1f\x0f\x07\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')


def _show_startup_logo():
    display.clear_display()
    display.graphics(chatgpt_logo_128x64)
    time.sleep_ms(1000)
    display.clear_display()


def _reset_prompt_form(prompt_value=" "):
    if prompt_value == "":
        prompt_value = " "
    form.input_list = {"inp_0": prompt_value}
    form.form_list = ["prompt:", "inp_0"]
    form.menu_cursor = 1
    form.input_cursor = len(prompt_value) if prompt_value != " " else 0
    form.input_display_position = 0
    form.update()


def _go_home():
    app.set_app_name("home")
    app.set_group_name("root")
    current_app[0] = "home"


def _rand_idx(limit):
    if limit <= 0:
        return 0
    return getrandbits(16) % limit


def _rand_ms(min_ms, max_ms):
    if max_ms <= min_ms:
        return min_ms
    return min_ms + (getrandbits(16) % (max_ms - min_ms + 1))


def _thinking_nav_animation_on_prompt(total_ms=1200, step_ms=150):
    # Runs on prompt screen navbar: Thinking. Thinking.. Thinking... Thinking..
    dots_seq = [".", "..", "...", ".."]
    frames = total_ms // step_ms
    for i in range(frames):
        form_refresh.refresh(state="             ")
        form_refresh.refresh(state="Thinking" + dots_seq[i % len(dots_seq)])
        time.sleep_ms(step_ms)


def _stream_fake_gpt(text_to_stream):
    # No separate thinking window; animate in navbar on prompt screen
    _thinking_nav_animation_on_prompt(total_ms=1200, step_ms=100)

    text.all_clear()
    text_refresh.new = True
    text_refresh.refresh(state=" > ChatGPT")

    for ch in text_to_stream:
        if ch in " ,.;" and _rand_idx(100) < 35:
            time.sleep_ms(_rand_ms(400, 600))

        if ch not in " \n" and _rand_idx(100) < 28:
            fake_ch = NOISE_CHARS[_rand_idx(len(NOISE_CHARS))]
            text.update_buffer(fake_ch)
            text_refresh.refresh(state="ChatGPT")
            time.sleep_ms(_rand_ms(20, 60))
            text.update_buffer("nav_b")

        text.update_buffer(ch)
        text_refresh.refresh(state="ChatGPT")
        time.sleep_ms(_rand_ms(18, 45))


def ChatGPT():
    display.clear_display()
    _show_startup_logo()

    _reset_prompt_form()
    form_refresh.refresh(state=nav.current_state())

    mode = "input"  # input | response
    last_prompt = " "

    while True:
        inp = typer.start_typing()

        if inp == "alpha" or inp == "beta":
            keypad_state_manager(x=inp)
            if mode == "input":
                form.update_buffer("")
                form_refresh.refresh(state=nav.current_state())
            else:
                text_refresh.refresh(state="ChatGPT")
            time.sleep(0.03)
            continue

        if mode == "input":
            if inp == "back":
                _go_home()
                break

            if inp == "ok":
                entered_prompt = form.inp_list().get("inp_0", " ").strip()
                last_prompt = entered_prompt if entered_prompt else " "
                _stream_fake_gpt(LOREM_50_WORDS)
                mode = "response"
                continue

            form.update_buffer(inp)
            form_refresh.refresh(state=nav.current_state())

        else:  # mode == "response"
            if inp == "back":
                display.clear_display()
                _reset_prompt_form(last_prompt)
                form_refresh.refresh(state=nav.current_state())
                mode = "input"
                continue

            if inp == "ok":
                display.clear_display()
                _reset_prompt_form(last_prompt)
                form_refresh.refresh(state=nav.current_state())
                mode = "input"
                continue

            if inp in ("nav_u", "nav_d", "nav_l", "nav_r", "nav_b"):
                text.update_buffer(inp)
                text_refresh.refresh(state="ChatGPT")

        time.sleep(0.03)
