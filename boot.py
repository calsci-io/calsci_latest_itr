import gc
import esp32
from sleeping_features import keypad_normal
keypad_normal()
import machine
opin = machine.Pin(14, machine.Pin.OUT, value=1, hold=False)  # Reinitialize the pin for deepsleep keypad
# from test_thread import run_thread
# opin.hold(False)
# from data_modules.object_handler import display
import st7565 as display
st7565_display_pins={"cs1":9, "rs":11, "rst":10, "sda":13, "sck":12} #2.9
# display.init(st7565_display_pins["cs1"], st7565_display_pins["rs"], st7565_display_pins["rst"], st7565_display_pins["sda"], st7565_display_pins["sck"])
# display.init(st7565_display_pins["cs1"], st7565_display_pins["rs"], st7565_display_pins["rst"], st7565_display_pins["sda"], st7565_display_pins["sck"]) #2.9
display.init(9, 11, 10, 13, 12)
cal_sci_buffer=bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0   \xa0\xa0\xa0\xa0            \xa0\xa0\xa0     \xa0\xa0\xa0\xa0             \xa0\xa0    \xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x00\x00\x1f?  1\x11\x00\x00\x10:**><\x00\x00\x00 ?? \x00\x00\x00\x137$$=\x19\x00\x00\x1c>""6\x14\x00\x00\x00\x00>>\x00\x00\x00\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xc1\x01\x01\xc1\xc1\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01A\xc1\xc1\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\xc1\xc1\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\x1f\x10\x10\x1f\x0f\x00\x00\x1f\x1f\x01\x01\x1f\x1e\x00\x00\x00\x10\x1f\x1f\x10\x00\x00\x00\x0e\x1f\x15\x15\x17\x16\x00\x00\x08\x1d\x15\x15\x1f\x1e\x00\x00\x12\x17\x15\x15\x1d\x08\x00\x00\x1f\x1f\x01\x01\x1f\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x0fxx\x0f\x07\x00\x008|DD|8\x00\x00<|@@|<\x00\x00||\x04\x04\x0c\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00A\x7f\x7fA\x00\x00\x00||\x180\x18||\x00 tTT|x\x00\x00\x98\xbc\xa4\xa4\xfc|\x00\x00\x00\x00}}\x00\x00\x00\x00||\x04\x04|x\x00\x00 tTT|x\x00\x04\x04?\x7fDd \x00\x00\x00\x00}}\x00\x00\x00\x008|DD|8\x00\x00||\x04\x04|x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
display.graphics(cal_sci_buffer)
# display.write_instruction(0x81) #for only 3.0
# display.write_instruction(0x06)
gc.enable()
print("free ram initially=", gc.mem_free())
print("ram allocated initially=", gc.mem_alloc())

# --- Triple Boot System ---
print("=================================")
print("  CalSci - Triple Boot System")
print("=================================")
print("  boot.switch_to_cpp()   - Reboot into C++")
print("  boot.switch_to_rust()  - Reboot into Rust")
print("  boot.boot_info()       - Show current partition")
print("=================================")


def boot_info():
    """Show current running partition info."""
    cur = esp32.Partition(esp32.Partition.RUNNING)
    print("Running from:", cur.info())
    print()
    print("All app partitions:")
    for p in esp32.Partition.find(esp32.Partition.TYPE_APP):
        print(" ", p.info())


def switch_to_cpp():
    """Switch to C++ (ota_1) and reboot."""
    _switch_to("ota_1", "C++")


def switch_to_rust():
    """Switch to Rust (ota_2) and reboot."""
    _switch_to("ota_2", "Rust")


def switch_to_micropython():
    """Switch back to MicroPython (ota_0) and reboot."""
    _switch_to("ota_0", "MicroPython")


def _decode_partition_field(value):
    if isinstance(value, bytes):
        try:
            return value.decode()
        except Exception:
            return None
    if isinstance(value, str):
        return value
    return None


def _partition_by_label(label):
    # Fast path for firmwares where Partition(label) is supported.
    try:
        return esp32.Partition(label)
    except Exception:
        pass

    # Fallback: scan app partitions and match label from info().
    try:
        parts = esp32.Partition.find(esp32.Partition.TYPE_APP)
    except Exception:
        return None

    for part in parts:
        try:
            info = part.info()
        except Exception:
            continue

        fields = info if isinstance(info, (tuple, list)) else (info,)
        for field in fields:
            if _decode_partition_field(field) == label:
                return part
    return None


def _switch_to(label, name):
    """Set boot partition and restart."""
    import time as _time
    try:
        part = _partition_by_label(label)
        if part is None:
            print("Error switching to", label, ": partition not found")
            return
        part.set_boot()
        print("Next boot:", name, "(" + label + ")")
        display.clear_display()
        menu.menu_list = ["Switching to:", name, "Rebooting..."]
        menu.update()
        menu_refresh.refresh()
        print("Restarting in 1 second...")
        _time.sleep(1)
        machine.reset()
    except Exception as e:
        print("Error switching to", label, ":", e)
# --- End Triple Boot System ---
from apps.settings.backlight import backlight_pin
# backlight_pin.off() #3.0
backlight_pin.on() #2.9
# from test_thread import run_thread
# run_thread()
# import uasyncio as asyncio
# from test_async import main
# asyncio.run(main())
import builtins
from data_modules.object_handler import text, menu, form, text_refresh, menu_refresh, form_refresh, typer, data_bucket
builtins.display=display
builtins.text=text
builtins.menu=menu
builtins.form=form
builtins.text_refresh=text_refresh
builtins.text_refresh=menu_refresh
builtins.text_refresh=form_refresh
builtins.typer=typer



# WiFi startup disabled for fast boot.
builtins.sta_if = None
data_bucket["connection_status_g"] = False
data_bucket["ssid_g"] = ""
