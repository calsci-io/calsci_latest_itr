import gc
from sleeping_features import keypad_normal
keypad_normal()
import machine
opin = machine.Pin(14, machine.Pin.OUT, value=1, hold=False)  # Reinitialize the pin for deepsleep keypad
# from test_thread import run_thread
# opin.hold(False)
# from data_modules.object_handler import display
import st7565 as display
st7565_display_pins={"cs1":9, "rs":11, "rst":10, "sda":13, "sck":12} #2.9
# display.init(st7565_display_pins["cs1"], st7565_display_pins["rs"], st7565_display_pins["rst"], st7565_display_pins["sda"], st7565_display_pins["sck"])
# display.init(st7565_display_pins["cs1"], st7565_display_pins["rs"], st7565_display_pins["rst"], st7565_display_pins["sda"], st7565_display_pins["sck"]) #2.9
display.init(9, 11, 10, 13, 12)
cal_sci_buffer=bytearray(b'\x00\x00\x00\x00\x00\x00\x00\xc0\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xe0\x07\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xe0\x07\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf0\x07\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf3\xcf\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xff\xff\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe0\xff\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xc0\x7f\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe7\xc0\x7f\xe7\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\xff\xe0\xff\xff\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf8\x0f\xff\xff\xf0\x1f\x80\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe0\x03\xff\xff\xc0\x03\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x07\x80\x00\xff\xff\x00A\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00\x7f\xfe\x00\xe0\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x00\x1f\xf8\x00\xe0p\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x00\x0f\xf0\x00\xe0p\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x00\x00\x07\xe0\x00\xe08\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x7f\xf0\x03\xe0\x00\xe08\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x7f\xf0\x03\xc0\x1f\xff8\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x7f\xf0\x03\xe0\x1f\xff8\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x00\x00\x07\xe0\x00`8\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x00\x0f\xf0\x00\xe0p\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x00\x1f\xf8\x00\xe0p\x00\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00|>\x00\xe0\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x07\x80\x00\xf8\x1f\x00a\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x03\xc0\x03\xe0\x07\xc0\x03\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf8\x0f\xc0\x03\xf0\x1f\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\xff\xff\xff\xff\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xff\xff\xff\xff\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\xff\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\xff\xff\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x008\x00\x00\x1c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00<\x00\x00\x1c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x00\x00<\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xff\xff\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xff\xff\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xff\xff\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe0\x07\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf0\x0f\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfc?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x08\x10\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x08\x00\x00\x00\x00\x00Fc1\x90\xff\x13\xc3\x8b\x91\xe5\xdc\x80\xf3\xbf\x00\x00fs9\x90\xcd\x92$L\x92&H\x81\x13\'\x00\x00.W+\x90\x88\x93\x04\x08\xd0$h\x81\x1a#\x00\x00*\xd5j\xb0\x88\x91\xcc\x08\xd3\xe4h\x83\x1ac\x00\x00+\x95\xca\xe0\x88\x90d\x08\xd2$h\x81\x1ac\x00\x009\x9c\xce`\x88\x96$H\xd6dh\x81\x12\'\x00\x00\x11\x88\xc4l\x88\x93\xc3\x88\xd3\xb4n\x98\xf2?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00<\x00')
display.graphics(cal_sci_buffer)
# display.write_instruction(0x81) #for only 3.0
# display.write_instruction(0x06)
gc.enable()
print("free ram initially=", gc.mem_free())
print("ram allocated initially=", gc.mem_alloc())
from apps.settings.backlight import backlight_pin
# backlight_pin.off() #3.0
backlight_pin.on() #2.9
# from test_thread import run_thread
# run_thread()
# import uasyncio as asyncio
# from test_async import main
# asyncio.run(main())
import builtins
from data_modules.object_handler import text, menu, form, text_refresh, menu_refresh, form_refresh, typer, data_bucket
builtins.display=display
builtins.text=text
builtins.menu=menu
builtins.form=form
builtins.text_refresh=text_refresh
builtins.text_refresh=menu_refresh
builtins.text_refresh=form_refresh
builtins.typer=typer



import network
import time
import json
import espnow
import _thread

sta_if = network.WLAN(network.STA_IF)
builtins.sta_if=sta_if
sta_if.active(False)
time.sleep(0.5)
gc.collect()
sta_if.active(True)

# Attempt WiFi connection using /database/wifi.json
wifi_config_file = "/db/wifi.json"

try:
    with open(wifi_config_file, "r") as f:
        wifi_data = json.load(f)
        
    # with open("/db/boot_up.json") as f:
    #     boot_data = json.load(f)
        
    # if boot_data["states"].get("wifi_connected"):

    scanned = sta_if.scan()
    available_ssids = [net[0].decode() for net in scanned]
    for entry in wifi_data:
        ssid = entry.get("ssid")
        password = entry.get("password")
        if ssid in available_ssids:
            print("Connecting to:", ssid)
            display.clear_display()
            menu.menu_list=["Connecting to:", str(ssid), "password:", password]
            menu.update()
            menu_refresh.refresh()
            print("connected to ", str(ssid), "password:", password)
            time.sleep(1)
            sta_if.connect(ssid, password)
            for _ in range(100):
                if sta_if.isconnected():
                    display.clear_display()
                    menu.menu_list=["Connected to:", str(ssid)]
                    menu.update()
                    menu_refresh.refresh()
                    data_bucket["ssid_g"] =ssid
                    time.sleep(1)
                    break
                time.sleep(0.1)
            break

    print("WiFi connected:", sta_if.isconnected())
    if sta_if.isconnected():
        print("IP config:", sta_if.ifconfig())
        data_bucket["connection_status_g"]=True
    else:
        display.clear_display()
        menu.menu_list=["wifi not connected"]
        menu.update()
        menu_refresh.refresh()
        time.sleep(2)
except Exception as e:
    print("WiFi setup skipped or failed:", e)

def receiver():
    print("my mac:",machine.unique_id())
    e = espnow.ESPNow()
    e.active(True)
    while True:
        try:
            host, msg = e.recv()
            if msg:
                mac_str = ''.join('{:02X}'.format(b) for b in host)
                print("From:", mac_str, "Message:", msg)
        except:
            print("message failed to recieve")

if sta_if.isconnected():
    _thread.start_new_thread(receiver, ())